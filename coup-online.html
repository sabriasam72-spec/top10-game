<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COUP ‚Äî Online Multiplayer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#080810; --surface:#0f0f1e; --surface2:#161628; --border:#1e1e3a; --border2:#2a2a4a;
  --gold:#c8a84b; --gold2:#e8cc7a; --gold-dim:rgba(200,168,75,0.15);
  --red:#c0392b; --red2:#e74c3c; --green:#1a7a4a; --green2:#27ae60;
  --blue:#1a4a7a; --blue2:#2980b9; --text:#d4cfe8; --text2:#8a85a0; --text3:#5a5570;
  --shadow:0 20px 60px rgba(0,0,0,0.8);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Crimson Pro',serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 600px 400px at 20% 30%,rgba(200,168,75,0.04) 0%,transparent 70%),radial-gradient(ellipse 400px 600px at 80% 70%,rgba(100,50,150,0.06) 0%,transparent 70%),radial-gradient(ellipse 800px 300px at 50% 100%,rgba(192,57,43,0.05) 0%,transparent 70%);pointer-events:none;z-index:0;}
#root{position:relative;z-index:1;min-height:100vh;}
.screen{display:none;}
.screen.active{display:flex;flex-direction:column;min-height:100vh;}

/* LOBBY */
#lobby{align-items:center;justify-content:center;padding:40px 20px;}
.masthead{text-align:center;margin-bottom:50px;}
.masthead-title{font-family:'Cinzel',serif;font-size:clamp(64px,12vw,110px);font-weight:900;letter-spacing:0.2em;color:var(--gold);text-shadow:0 0 60px rgba(200,168,75,0.3),0 0 120px rgba(200,168,75,0.1);line-height:1;}
.masthead-sub{font-family:'Crimson Pro',serif;font-style:italic;font-size:16px;color:var(--text2);letter-spacing:0.3em;margin-top:10px;}
.masthead-div{width:120px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:16px auto 0;}
.lobby-card{background:var(--surface);border:1px solid var(--border2);border-radius:4px;padding:40px;width:100%;max-width:440px;box-shadow:var(--shadow);position:relative;}
.lobby-card::before{content:'';position:absolute;top:0;left:30px;right:30px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.sec-label{font-family:'Cinzel',serif;font-size:10px;letter-spacing:0.3em;color:var(--text3);text-transform:uppercase;margin-bottom:18px;display:flex;align-items:center;gap:12px;}
.sec-label::after{content:'';flex:1;height:1px;background:var(--border2);}
.inp-g{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.inp-l{font-size:12px;color:var(--text2);letter-spacing:0.1em;}
.inp{background:var(--surface2);border:1px solid var(--border2);border-radius:3px;padding:12px 16px;color:var(--text);font-family:'Crimson Pro',serif;font-size:16px;outline:none;transition:border-color 0.2s;width:100%;}
.inp:focus{border-color:var(--gold);}
.inp::placeholder{color:var(--text3);}
.btn-gold{width:100%;background:linear-gradient(135deg,#8a6b20,#c8a84b,#8a6b20);background-size:200%;border:none;border-radius:3px;padding:14px;font-family:'Cinzel',serif;font-size:13px;font-weight:700;letter-spacing:0.2em;color:#000;cursor:pointer;transition:all 0.3s;margin-top:6px;}
.btn-gold:hover{background-position:100%;box-shadow:0 0 30px rgba(200,168,75,0.3);}
.div-or{display:flex;align-items:center;gap:16px;margin:26px 0;color:var(--text3);font-size:12px;letter-spacing:0.2em;}
.div-or::before,.div-or::after{content:'';flex:1;height:1px;background:var(--border2);}

/* WAITING */
#waiting{align-items:center;justify-content:center;padding:40px 20px;}
.room-panel{background:var(--surface);border:1px solid var(--border2);border-radius:4px;padding:40px;width:100%;max-width:500px;box-shadow:var(--shadow);position:relative;}
.room-panel::before{content:'';position:absolute;top:0;left:30px;right:30px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.room-code-big{font-family:'Cinzel',serif;font-size:48px;font-weight:900;color:var(--gold);letter-spacing:0.3em;text-shadow:0 0 40px rgba(200,168,75,0.4);cursor:pointer;transition:all 0.2s;text-align:center;display:block;}
.room-code-big:hover{transform:scale(1.05);}
.w-players{display:flex;flex-direction:column;gap:7px;margin:20px 0 24px;}
.w-player{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:3px;font-size:15px;}
.w-player.host{border-color:var(--gold);}
.online-dot{width:7px;height:7px;border-radius:50%;background:var(--green2);box-shadow:0 0 7px var(--green2);}
.w-slot{display:flex;align-items:center;gap:10px;padding:10px 14px;border:1px dashed var(--border);border-radius:3px;font-size:13px;color:var(--text3);font-style:italic;}
.pulse{width:7px;height:7px;border-radius:50%;background:var(--text3);animation:pl 2s infinite;}
@keyframes pl{0%,100%{opacity:.3}50%{opacity:1}}
.btn-green{width:100%;background:linear-gradient(135deg,#1a5a2a,#27ae60,#1a5a2a);background-size:200%;border:none;border-radius:3px;padding:14px;font-family:'Cinzel',serif;font-size:13px;font-weight:700;letter-spacing:0.2em;color:#fff;cursor:pointer;transition:all 0.3s;margin-bottom:10px;}
.btn-green:disabled{opacity:.4;cursor:not-allowed;}
.btn-green:not(:disabled):hover{background-position:100%;box-shadow:0 0 30px rgba(39,174,96,0.3);}
.btn-ghost{width:100%;background:transparent;border:1px solid var(--border2);border-radius:3px;padding:12px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:0.2em;color:var(--text2);cursor:pointer;transition:all 0.2s;}
.btn-ghost:hover{border-color:var(--text);color:var(--text);}

/* GAME */
#game{padding:0;overflow:hidden;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;}
.tl{display:flex;align-items:center;gap:12px;}
.g-title{font-family:'Cinzel',serif;font-size:18px;font-weight:900;color:var(--gold);letter-spacing:0.2em;}
.turn-chip{background:var(--gold-dim);border:1px solid rgba(200,168,75,0.3);border-radius:2px;padding:3px 10px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:0.15em;color:var(--gold);}
.tr{display:flex;align-items:center;gap:16px;font-size:12px;color:var(--text2);}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--green2);box-shadow:0 0 6px var(--green2);animation:pl 2s infinite;}
.game-body{display:grid;grid-template-columns:260px 1fr;height:calc(100vh - 49px);overflow:hidden;}
.pcol{background:#09091a;border-left:1px solid var(--border);overflow-y:auto;padding:14px;}
.col-h{font-family:'Cinzel',serif;font-size:9px;letter-spacing:0.35em;color:var(--text3);padding-bottom:9px;border-bottom:1px solid var(--border);margin-bottom:11px;}
.pc{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:11px;margin-bottom:7px;transition:all 0.3s;position:relative;overflow:hidden;}
.pc::before{content:'';position:absolute;top:0;left:0;width:2px;height:100%;background:transparent;transition:background 0.3s;}
.pc.ct::before{background:var(--gold);}
.pc.cm::before{background:var(--blue2);}
.pc.ct.cm::before{background:var(--gold);}
.pc.elim{opacity:.3;filter:grayscale(.8);}
.pct{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:#000;flex-shrink:0;}
.pn{font-size:13px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.py{font-size:9px;color:var(--blue2);letter-spacing:.1em;font-family:'Cinzel',serif;}
.pco{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--gold);display:flex;align-items:center;gap:3px;}
.pi{display:flex;gap:4px;flex-wrap:wrap;}
.pip{font-size:10px;padding:2px 6px;border-radius:2px;background:var(--surface2);border:1px solid var(--border2);color:var(--text2);font-family:'Cinzel',serif;}
.pip.dead{background:rgba(192,57,43,.1);border-color:rgba(192,57,43,.3);color:rgba(192,57,43,.5);text-decoration:line-through;}
.ccol{display:flex;flex-direction:column;overflow:hidden;}
.az{flex:1;overflow-y:auto;padding:20px;}
.my-hand{background:var(--surface);border:1px solid var(--border2);border-radius:3px;padding:15px;margin-bottom:18px;position:relative;}
.my-hand::before{content:'';position:absolute;top:0;left:20px;right:20px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.hl{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.3em;color:var(--gold);opacity:.6;margin-bottom:11px;}
.hcards{display:flex;gap:9px;}
.hcard{flex:1;border-radius:3px;padding:13px 10px;border:1px solid;text-align:center;position:relative;}
.hcard.dead{opacity:.3;filter:grayscale(.8);}
.hce{font-size:24px;margin-bottom:4px;}
.hcn{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.1em;font-weight:700;}
.hdx{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:34px;opacity:.4;}
.aal{font-family:'Cinzel',serif;font-size:9px;letter-spacing:.3em;color:var(--text3);margin-bottom:13px;}
.agrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:9px;}
.abtn{background:var(--surface);border:1px solid var(--border);border-radius:3px;padding:13px;cursor:pointer;transition:all 0.2s;text-align:left;}
.abtn:hover:not(:disabled){border-color:rgba(200,168,75,.4);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.5);}
.abtn.danger:hover:not(:disabled){border-color:rgba(231,76,60,.5);box-shadow:0 8px 24px rgba(192,57,43,.3);}
.abtn:disabled{opacity:.3;cursor:not-allowed;}
.atop{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:7px;}
.aico{font-size:21px;}
.acost{font-family:'Cinzel',serif;font-size:10px;padding:2px 7px;border-radius:2px;font-weight:700;}
.cg{background:rgba(200,168,75,.15);color:var(--gold);}
.cf{background:rgba(39,174,96,.15);color:var(--green2);}
.aname{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--text);margin-bottom:3px;}
.adesc{font-size:12px;color:var(--text2);line-height:1.4;font-style:italic;}
.atag{display:inline-block;margin-top:7px;font-size:9px;padding:2px 7px;border-radius:2px;font-family:'Cinzel',serif;letter-spacing:.05em;}
.noturn{background:var(--surface);border:1px solid var(--border2);border-radius:3px;padding:28px;text-align:center;margin-bottom:18px;}
.ntn{font-family:'Cinzel',serif;font-size:19px;color:var(--gold);margin-bottom:5px;}
.nts{font-size:14px;color:var(--text2);font-style:italic;}
.logp{border-top:1px solid var(--border);background:#06060f;height:128px;overflow-y:auto;padding:9px 18px;}
.lgh{font-family:'Cinzel',serif;font-size:8px;letter-spacing:.35em;color:var(--text3);margin-bottom:7px;}
.lgl{font-size:13px;color:var(--text3);padding:2px 0;font-style:italic;}
.lgl:last-child{color:var(--text2);}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(12px);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;}
.overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:4px;padding:30px;max-width:460px;width:100%;box-shadow:var(--shadow);animation:ma .25s ease;position:relative;}
.modal::before{content:'';position:absolute;top:0;left:30px;right:30px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);}
@keyframes ma{from{opacity:0;transform:scale(.95) translateY(16px)}to{opacity:1;transform:scale(1) translateY(0)}}
.mt{font-family:'Cinzel',serif;font-size:17px;font-weight:700;color:var(--gold);text-align:center;margin-bottom:7px;letter-spacing:.1em;}
.mb{font-size:14px;color:var(--text2);text-align:center;margin-bottom:20px;line-height:1.6;font-style:italic;}
.mlist{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.mitem{background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:11px 13px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:9px;font-size:14px;}
.mitem:hover{border-color:var(--red2);background:rgba(231,76,60,.08);}
.mav{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:10px;font-weight:700;color:#000;flex-shrink:0;}
.mco{margin-right:auto;font-size:11px;color:var(--gold);font-family:'Cinzel',serif;}
.cgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:12px;}
.cpick{background:var(--surface2);border:2px solid var(--border);border-radius:3px;padding:13px 9px;cursor:pointer;transition:all .2s;text-align:center;color:var(--text);}
.cpick:hover{transform:translateY(-2px);}
.cpick.sel{outline:2px solid var(--gold);outline-offset:1px;transform:translateY(-3px);}
.cpe{font-size:24px;margin-bottom:4px;}
.cpn{font-family:'Cinzel',serif;font-size:10px;letter-spacing:.1em;}
.ehint{text-align:center;font-size:12px;color:var(--text3);font-style:italic;margin-bottom:12px;min-height:16px;}
.mbtns{display:flex;gap:7px;}
.mbtns>*{flex:1;}
.mbtn{padding:12px;border-radius:3px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:.15em;font-weight:700;cursor:pointer;border:none;transition:all .2s;}
.mbtn-gold{background:linear-gradient(135deg,#8a6b20,#c8a84b);color:#000;}
.mbtn-gold:disabled{opacity:.4;cursor:not-allowed;}
.mbtn-red{background:linear-gradient(135deg,#7a1a14,#c0392b);color:#fff;}
.mbtn-ghost{background:transparent;border:1px solid var(--border2);color:var(--text2);}
.mbtn-ghost:hover{border-color:var(--text);color:var(--text);}

/* WIN */
#win-screen{align-items:center;justify-content:center;text-align:center;padding:40px;}
.wi{max-width:400px;}
.wt{font-size:60px;margin-bottom:10px;animation:fl 3s ease-in-out infinite;}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.wc{font-family:'Cinzel',serif;font-size:clamp(32px,8vw,56px);font-weight:900;color:var(--gold);text-shadow:0 0 40px rgba(200,168,75,.5);margin-bottom:8px;}
.wd{width:80px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:14px auto;}
.wn{font-family:'Cinzel',serif;font-size:20px;color:var(--text);margin-bottom:38px;}

/* REF */
.ref-fab{position:fixed;bottom:20px;right:20px;width:42px;height:42px;background:var(--surface);border:1px solid var(--border2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;z-index:200;transition:all .2s;box-shadow:0 4px 16px rgba(0,0,0,.5);}
.ref-fab:hover{border-color:var(--gold);transform:scale(1.1);}
.rgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px;max-height:360px;overflow-y:auto;}
.ri{border-radius:3px;padding:10px;border:1px solid;}
.rit{font-family:'Cinzel',serif;font-size:10px;font-weight:700;margin-bottom:3px;}
.ril{font-size:11px;opacity:.7;line-height:1.4;font-style:italic;}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--surface2);border:1px solid var(--border2);border-radius:3px;padding:9px 18px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:.1em;color:var(--text);z-index:9999;opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

@media(max-width:640px){
  .game-body{grid-template-columns:1fr;height:auto;}
  .pcol{max-height:190px;order:-1;}
  .agrid{grid-template-columns:1fr 1fr;}
}
</style>
</head>
<body>
<div id="root">

<div id="lobby" class="screen active">
  <div class="masthead">
    <div class="masthead-title">COUP</div>
    <div class="masthead-div"></div>
    <div class="masthead-sub">a game of deception &amp; power</div>
  </div>
  <div class="lobby-card">
    <div class="sec-label">Create a Room</div>
    <div class="inp-g"><div class="inp-l">Your Name</div><input class="inp" id="cn" placeholder="Enter your name" maxlength="18"></div>
    <button class="btn-gold" onclick="createRoom()">CREATE ROOM</button>
    <div class="div-or">‚Äî or ‚Äî</div>
    <div class="sec-label">Join a Room</div>
    <div class="inp-g"><div class="inp-l">Your Name</div><input class="inp" id="jn" placeholder="Enter your name" maxlength="18"></div>
    <div class="inp-g"><div class="inp-l">Room Code</div><input class="inp" id="jc" placeholder="e.g. A4B2" maxlength="4" style="text-transform:uppercase;letter-spacing:.2em;font-family:'Cinzel',serif;font-size:18px;"></div>
    <button class="btn-gold" onclick="joinRoom()">JOIN ROOM</button>
  </div>
</div>

<div id="waiting" class="screen">
  <div style="text-align:center;margin-bottom:28px;">
    <div style="font-family:'Cinzel',serif;font-size:26px;font-weight:900;color:var(--gold);letter-spacing:.2em;">COUP</div>
    <div style="font-size:13px;color:var(--text3);letter-spacing:.2em;font-style:italic;margin-top:4px;">Waiting Room</div>
  </div>
  <div class="room-panel">
    <div style="font-family:'Cinzel',serif;font-size:9px;letter-spacing:.3em;color:var(--text3);text-align:center;margin-bottom:5px;">ROOM CODE ‚Äî SHARE WITH FRIENDS</div>
    <span class="room-code-big" id="rcd" onclick="copyCode()" title="Click to copy">‚Äî</span>
    <div style="font-size:12px;color:var(--text3);text-align:center;font-style:italic;margin-bottom:22px;">Click to copy &amp; share</div>
    <div class="sec-label">Players <span id="pcl" style="color:var(--text2);font-size:10px;font-family:'Crimson Pro',serif;font-style:italic;letter-spacing:0;font-weight:400;">0/6</span></div>
    <div class="w-players" id="wpl"></div>
    <button class="btn-green" id="sbtn" onclick="startGame()" disabled>START GAME</button>
    <button class="btn-ghost" onclick="leaveRoom()">‚Üê Leave Room</button>
  </div>
</div>

<div id="game" class="screen">
  <div class="topbar">
    <div class="tl">
      <div class="g-title">COUP</div>
      <div class="turn-chip" id="tchip">‚Äî</div>
    </div>
    <div class="tr">
      <span>üÉè <span id="dcount">‚Äî</span></span>
      <div style="display:flex;align-items:center;gap:5px;">
        <div class="sync-dot" id="sdot"></div>
        <span style="font-family:'Cinzel',serif;letter-spacing:.1em;font-size:11px;" id="rcs"></span>
      </div>
    </div>
  </div>
  <div class="game-body">
    <div class="pcol">
      <div class="col-h">Players</div>
      <div id="gpl"></div>
    </div>
    <div class="ccol">
      <div class="az" id="az"></div>
      <div class="logp">
        <div class="lgh">Event Log</div>
        <div id="elog"></div>
      </div>
    </div>
  </div>
</div>

<div id="win-screen" class="screen">
  <div class="wi">
    <div class="wt">üèÜ</div>
    <div class="wc">VICTORY</div>
    <div class="wd"></div>
    <div class="wn" id="wname">‚Äî</div>
    <button class="btn-gold" style="max-width:240px;margin:0 auto;" onclick="goLobby()">NEW GAME</button>
  </div>
</div>

</div>

<button class="ref-fab" onclick="openM('ref-modal')" title="Card Reference">üìñ</button>
<div class="toast" id="toast"></div>

<!-- MODALS -->
<div class="overlay" id="target-modal">
  <div class="modal">
    <div class="mt" id="tmt">Choose Target</div>
    <div class="mb" id="tmb">Select a player to target</div>
    <div class="mlist" id="tml"></div>
    <div class="mbtns"><button class="mbtn mbtn-ghost" onclick="closeM('target-modal')">Cancel</button></div>
  </div>
</div>

<div class="overlay" id="lose-modal">
  <div class="modal">
    <div class="mt">Lose Influence</div>
    <div class="mb" id="lmb">Choose a card to reveal and lose</div>
    <div class="cgrid" id="lcl"></div>
  </div>
</div>

<div class="overlay" id="exchange-modal">
  <div class="modal">
    <div class="mt">Exchange Cards</div>
    <div class="mb">Choose the cards you wish to keep</div>
    <div class="cgrid" id="ecl"></div>
    <div class="ehint" id="ehint">Select cards to keep</div>
    <div class="mbtns">
      <button class="mbtn mbtn-gold" id="econf" onclick="confirmExchange()" disabled>CONFIRM</button>
      <button class="mbtn mbtn-ghost" onclick="closeM('exchange-modal')">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="challenge-modal">
  <div class="modal">
    <div class="mt">‚öî Challenge?</div>
    <div class="mb" id="chb"></div>
    <div class="mbtns">
      <button class="mbtn mbtn-red" onclick="resolveChallenge(true)">CHALLENGE</button>
      <button class="mbtn mbtn-gold" onclick="resolveChallenge(false)">ALLOW</button>
    </div>
  </div>
</div>

<div class="overlay" id="block-modal">
  <div class="modal">
    <div class="mt">üõ° Block?</div>
    <div class="mb" id="blb"></div>
    <div class="mbtns">
      <button class="mbtn mbtn-red" onclick="resolveBlock('block')">BLOCK</button>
      <button class="mbtn mbtn-gold" onclick="resolveBlock('allow')">ALLOW</button>
    </div>
  </div>
</div>

<div class="overlay" id="ann-modal">
  <div class="modal">
    <div class="mt" id="annt"></div>
    <div class="mb" id="annb"></div>
    <div class="mbtns"><button class="mbtn mbtn-gold" onclick="closeM('ann-modal');if(window._acb)window._acb();">OK</button></div>
  </div>
</div>

<div class="overlay" id="ref-modal">
  <div class="modal" style="max-width:520px;">
    <div class="mt">Card Reference</div>
    <div class="rgrid" id="rgrid"></div>
    <button class="mbtn mbtn-ghost" style="width:100%;" onclick="closeM('ref-modal')">Close</button>
  </div>
</div>

<script>
const CARDS={
  duke:      {name:'Duke',      emoji:'üëë',color:'#7d3c98',border:'#9b59b6',bg:'rgba(155,89,182,0.15)',action:'Tax: take 3 coins',         blocks:'Blocks Foreign Aid'},
  assassin:  {name:'Assassin',  emoji:'üó°Ô∏è',color:'#c0392b',border:'#e74c3c',bg:'rgba(231,76,60,0.12)',  action:'Assassinate for 3 coins',   blocks:'Nothing'},
  ambassador:{name:'Ambassador',emoji:'ü§ù',color:'#1e8449',border:'#27ae60',bg:'rgba(39,174,96,0.12)',  action:'Exchange cards with deck',  blocks:'Blocks Steal'},
  captain:   {name:'Captain',   emoji:'‚öì',color:'#1a5276',border:'#2980b9',bg:'rgba(41,128,185,0.12)', action:'Steal 2 coins',             blocks:'Blocks Steal'},
  contessa:  {name:'Contessa',  emoji:'üíé',color:'#922b8c',border:'#e91e8c',bg:'rgba(233,30,140,0.12)', action:'No direct action',          blocks:'Blocks Assassination'}
};

const ACTIONS=[
  {key:'income',      name:'Income',      emoji:'üí∞',desc:'Take 1 coin from the bank.',                              cost:0,target:false,card:null,       blockBy:null,               challenge:false},
  {key:'foreign_aid', name:'Foreign Aid', emoji:'üè¶',desc:'Take 2 coins. The Duke can block this.',                 cost:0,target:false,card:null,       blockBy:'duke',             challenge:false},
  {key:'coup',        name:'Coup',        emoji:'üí•',desc:'Pay 7 coins. Force a player to lose an influence. Unblockable.',cost:7,target:true,card:null,blockBy:null,challenge:false,isCoup:true},
  {key:'tax',         name:'Tax',         emoji:'üëë',desc:'Claim Duke. Take 3 coins.',                               cost:0,target:false,card:'duke',     blockBy:null,               challenge:true},
  {key:'assassinate', name:'Assassinate', emoji:'üó°Ô∏è',desc:'Pay 3 coins. Claim Assassin. Force opponent to lose influence.',cost:3,target:true,card:'assassin',blockBy:'contessa',challenge:true},
  {key:'steal',       name:'Steal',       emoji:'‚öì',desc:'Claim Captain. Take 2 coins from another player.',        cost:0,target:true, card:'captain',  blockBy:'amb_cap',          challenge:true},
  {key:'exchange',    name:'Exchange',    emoji:'ü§ù',desc:'Claim Ambassador. Exchange cards with the Court deck.',   cost:0,target:false,card:'ambassador',blockBy:null,              challenge:true}
];

const COLORS=['#e74c3c','#e67e22','#f1c40f','#2ecc71','#3498db','#9b59b6'];

let ME={id:null,name:'',room:''};
let P={action:null,targetIdx:null,challenge:null,excSel:[],excAvail:[],excKeep:0,excRoom:null,excMe:null,blockCb:null};
let syncInt=null,lastVer=0;

// === STORAGE ===
async function save(room,data){try{await window.storage.set('coup:'+room,JSON.stringify(data),true);}catch(e){}}
async function load(room){try{const r=await window.storage.get('coup:'+room,true);return r?JSON.parse(r.value):null;}catch(e){return null;}}

// === HELPERS ===
function genCode(){const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let s='';for(let i=0;i<4;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
function genId(){return Math.random().toString(36).slice(2,10);}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function elim(p){return p.cards.length===0;}
function showS(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
function toast(msg,d=2500){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),d);}
function addLog(room,msg){if(!room.logs)room.logs=[];room.logs.push(msg);if(room.logs.length>60)room.logs.shift();}

// === CREATE/JOIN ===
async function createRoom(){
  const name=document.getElementById('cn').value.trim()||'Player 1';
  ME={id:genId(),name,room:genCode()};
  const deck=buildDeck();
  const room={id:ME.room,host:ME.id,status:'waiting',version:1,
    players:[{id:ME.id,name,colorIdx:0,coins:2,cards:[],deadCards:[],online:true}],
    deck,currentIdx:0,logs:[]};
  await save(ME.room,room);
  showWaiting(room);
  startSync();
}

async function joinRoom(){
  const name=document.getElementById('jn').value.trim()||'Player';
  const code=document.getElementById('jc').value.trim().toUpperCase();
  if(!code||code.length!==4){toast('Enter a 4-character room code');return;}
  const room=await load(code);
  if(!room){toast('Room not found!');return;}
  if(room.status!=='waiting'){toast('Game already started!');return;}
  if(room.players.length>=6){toast('Room is full!');return;}
  ME={id:genId(),name,room:code};
  room.players.push({id:ME.id,name,colorIdx:room.players.length%COLORS.length,coins:2,cards:[],deadCards:[],online:true});
  room.version++;
  await save(code,room);
  showWaiting(room);
  startSync();
}

function buildDeck(){let d=[];Object.keys(CARDS).forEach(t=>{for(let i=0;i<3;i++)d.push(t);});return shuffle(d);}

// === WAITING ===
function showWaiting(room){
  showS('waiting');
  document.getElementById('rcd').textContent=room.id;
  renderWaiting(room);
}

function renderWaiting(room){
  const list=document.getElementById('wpl');
  list.innerHTML='';
  room.players.forEach(p=>{
    const d=document.createElement('div');
    d.className='w-player'+(p.id===room.host?' host':'');
    d.innerHTML=`<div class="online-dot"></div><div style="flex:1;">${p.name}${p.id===ME.id?' <span style="font-size:10px;color:var(--blue2);font-family:Cinzel,serif;">(You)</span>':''}</div>${p.id===room.host?'<span style="color:var(--gold);font-size:12px;">‚ôõ Host</span>':''}`;
    list.appendChild(d);
  });
  for(let i=room.players.length;i<Math.max(2,room.players.length+1)&&i<6;i++){
    const d=document.createElement('div');d.className='w-slot';
    d.innerHTML=`<div class="pulse"></div><span>Waiting for player...</span>`;
    list.appendChild(d);
  }
  document.getElementById('pcl').textContent=room.players.length+'/6';
  const sb=document.getElementById('sbtn');
  const isHost=room.host===ME.id;
  sb.disabled=!isHost||room.players.length<2;
  sb.textContent=isHost?(room.players.length<2?'Need at least 2 players':'START GAME'):'Waiting for host...';
}

async function startGame(){
  const room=await load(ME.room);
  if(!room||room.host!==ME.id)return;
  const deck=buildDeck();
  room.players.forEach(p=>{p.cards=[deck.pop(),deck.pop()];p.deadCards=[];p.coins=2;});
  room.deck=deck;room.status='playing';room.currentIdx=0;
  room.logs=['‚öî The game of Coup begins. Let deception commence.'];
  room.version++;room.pendingAction=null;
  await save(ME.room,room);
}

async function leaveRoom(){clearInterval(syncInt);showS('lobby');}

// === SYNC ===
function startSync(){clearInterval(syncInt);syncInt=setInterval(syncRoom,1200);}

async function syncRoom(){
  const room=await load(ME.room);
  if(!room)return;
  if(room.version===lastVer)return;
  lastVer=room.version;
  if(room.status==='waiting'){renderWaiting(room);return;}
  if(room.status==='playing'){
    if(!document.getElementById('game').classList.contains('active'))showS('game');
    renderGame(room);return;
  }
  if(room.status==='finished'){
    const w=room.players.find(p=>!elim(p));
    if(w){document.getElementById('wname').textContent=w.name+' has won!';showS('win-screen');clearInterval(syncInt);}
  }
}

// === RENDER ===
function renderGame(room){
  const me=room.players.find(p=>p.id===ME.id);
  const cp=room.players[room.currentIdx];
  const myTurn=cp&&cp.id===ME.id;
  document.getElementById('tchip').textContent=(cp?cp.name:'?')+"'s Turn";
  document.getElementById('dcount').textContent=room.deck.length;
  document.getElementById('rcs').textContent=room.id;
  renderPlayers(room,me);
  renderActions(room,me,myTurn,cp);
  renderLog(room);
}

function renderPlayers(room,me){
  const list=document.getElementById('gpl');list.innerHTML='';
  room.players.forEach((p,i)=>{
    const iT=i===room.currentIdx,isM=me&&p.id===me.id,el=elim(p);
    const div=document.createElement('div');
    div.className='pc'+(iT?' ct':'')+(isM?' cm':'')+(el?' elim':'');
    let inf='';
    if(isM){p.cards.forEach(c=>{inf+=`<span class="pip" style="border-color:${CARDS[c].border};color:${CARDS[c].border}">${CARDS[c].emoji} ${CARDS[c].name}</span>`;});}
    else{for(let i=0;i<p.cards.length;i++)inf+=`<span class="pip">üÇ† Hidden</span>`;}
    p.deadCards.forEach(c=>{inf+=`<span class="pip dead">${CARDS[c].emoji} ${CARDS[c].name}</span>`;});
    div.innerHTML=`<div class="pct"><div class="av" style="background:${COLORS[p.colorIdx]}">${p.name.charAt(0)}</div><div class="pn">${p.name}${isM?'<br><span class="py">YOU</span>':''}</div><div class="pco">ü™ô${p.coins}</div></div><div class="pi">${inf||'<span style="color:var(--red2);font-size:10px;">Eliminated</span>'}</div>`;
    list.appendChild(div);
  });
}

function renderActions(room,me,myTurn,cp){
  const az=document.getElementById('az');az.innerHTML='';
  if(me){
    const h=document.createElement('div');h.className='my-hand';
    let ch=me.cards.map(c=>`<div class="hcard" style="border-color:${CARDS[c].border};background:${CARDS[c].bg}"><div class="hce">${CARDS[c].emoji}</div><div class="hcn">${CARDS[c].name}</div></div>`).join('');
    me.deadCards.forEach(c=>{ch+=`<div class="hcard dead" style="border-color:#3a1a1a;background:rgba(192,57,43,.08)"><div class="hce">${CARDS[c].emoji}</div><div class="hcn">${CARDS[c].name}</div><div class="hdx">‚úó</div></div>`;});
    h.innerHTML=`<div class="hl">YOUR HAND</div><div class="hcards">${ch}</div>`;
    az.appendChild(h);
  }
  if(!myTurn||!me||elim(me)){
    const o=document.createElement('div');o.className='noturn';
    if(me&&elim(me))o.innerHTML=`<div class="ntn" style="color:var(--red2)">You have been eliminated</div><div class="nts">Watch the intrigue unfold...</div>`;
    else o.innerHTML=`<div class="ntn">${cp?cp.name:'?'}</div><div class="nts">is taking their turn...</div>`;
    az.appendChild(o);return;
  }
  const mustCoup=me.coins>=10;
  if(mustCoup){const w=document.createElement('div');w.style.cssText='color:var(--red2);font-size:13px;font-style:italic;margin-bottom:13px;padding:9px;border:1px solid rgba(192,57,43,.3);border-radius:3px;background:rgba(192,57,43,.06);';w.textContent='‚ö† You have 10+ coins ‚Äî you must launch a Coup!';az.appendChild(w);}
  const lbl=document.createElement('div');lbl.className='aal';lbl.textContent='CHOOSE YOUR ACTION';az.appendChild(lbl);
  const grid=document.createElement('div');grid.className='agrid';
  ACTIONS.forEach(a=>{
    const btn=document.createElement('button');
    btn.className='abtn'+(a.isCoup?' danger':'');
    const dis=me.coins<a.cost||(mustCoup&&a.key!=='coup');
    const costHtml=a.cost>0?`<span class="acost cg">-${a.cost} ü™ô</span>`:`<span class="acost cf">Free</span>`;
    const tag=a.card?`<span class="atag" style="background:${CARDS[a.card].bg};color:${CARDS[a.card].border};border:1px solid ${CARDS[a.card].border};">${CARDS[a.card].emoji} ${CARDS[a.card].name}</span>`:'';
    btn.innerHTML=`<div class="atop"><span class="aico">${a.emoji}</span>${costHtml}</div><div class="aname">${a.name}</div><div class="adesc">${a.desc}</div>${tag}`;
    if(dis)btn.disabled=true;else btn.onclick=()=>handleAction(a,room,me);
    grid.appendChild(btn);
  });
  az.appendChild(grid);
}

function renderLog(room){
  const el=document.getElementById('elog');
  el.innerHTML=(room.logs||[]).slice(-20).map(l=>`<div class="lgl">${l}</div>`).join('');
  el.scrollTop=el.scrollHeight;
}

// === ACTION FLOW ===
async function handleAction(action,room,me){
  P.action=action;
  if(action.target){showTargetModal(action,room);}
  else if(action.challenge){showChallengeModal(action,null,room,me);}
  else if(action.blockBy){showBlockModal(action,null,room,me,()=>executeAction(action,null,room));}
  else{await executeAction(action,null,room);}
}

function showTargetModal(action,room){
  document.getElementById('tmt').textContent=action.emoji+' '+action.name;
  document.getElementById('tmb').textContent='Select a player to target';
  const list=document.getElementById('tml');list.innerHTML='';
  room.players.forEach((p,i)=>{
    if(p.id===ME.id||elim(p))return;
    const d=document.createElement('div');d.className='mitem';
    d.innerHTML=`<div class="mav" style="background:${COLORS[p.colorIdx]}">${p.name.charAt(0)}</div><span>${p.name}</span><span class="mco">ü™ô${p.coins}</span>`;
    d.onclick=()=>{closeM('target-modal');P.targetIdx=i;const me=room.players.find(p=>p.id===ME.id);if(action.challenge)showChallengeModal(action,i,room,me);else if(action.blockBy)showBlockModal(action,i,room,me,()=>executeAction(action,i,room));else executeAction(action,i,room);};
    list.appendChild(d);
  });
  openM('target-modal');
}

function showChallengeModal(action,targetIdx,room,me){
  const t=targetIdx!==null?room.players[targetIdx]:null;
  const ct=CARDS[action.card];
  document.getElementById('chb').innerHTML=`<strong style="color:var(--gold)">${me.name}</strong> claims to hold <strong style="color:${ct.border}">${ct.emoji} ${ct.name}</strong> for <strong>${action.name}</strong>${t?` against <strong style="color:var(--red2)">${t.name}</strong>`:''}<br><br><span style="font-size:13px;">Does anyone challenge?</span>`;
  P.challenge={action,targetIdx};
  openM('challenge-modal');
}

function resolveChallenge(challenged){
  closeM('challenge-modal');
  const{action,targetIdx}=P.challenge;
  load(ME.room).then(room=>{
    const me=room.players.find(p=>p.id===ME.id);
    const has=me.cards.includes(action.card);
    if(challenged){
      if(has){
        const i=me.cards.indexOf(action.card);me.cards.splice(i,1);room.deck.unshift(action.card);shuffle(room.deck);if(room.deck.length>0)me.cards.push(room.deck.pop());
        addLog(room,`‚öî Challenge failed! ${me.name} revealed ${CARDS[action.card].emoji} ${CARDS[action.card].name}`);room.version++;
        save(ME.room,room).then(()=>{if(action.blockBy)showBlockModal(action,targetIdx,room,me,()=>executeAction(action,targetIdx,room));else executeAction(action,targetIdx,room);});
      }else{
        addLog(room,`‚öî Challenge succeeded! ${me.name} does not have ${CARDS[action.card].emoji} ${CARDS[action.card].name}`);room.version++;
        save(ME.room,room).then(()=>doLoseCard(room,room.players.indexOf(me),()=>endTurn(room)));
      }
    }else{
      if(action.blockBy)showBlockModal(action,targetIdx,room,me,()=>executeAction(action,targetIdx,room));
      else executeAction(action,targetIdx,room);
    }
  });
}

function showBlockModal(action,targetIdx,room,me,onAllow){
  const t=targetIdx!==null?room.players[targetIdx]:null;
  const bc=action.blockBy==='duke'?'üëë Duke':action.blockBy==='contessa'?'üíé Contessa':'ü§ù Ambassador or ‚öì Captain';
  document.getElementById('blb').innerHTML=`Can any player block <strong style="color:var(--gold)">${me.name}</strong>'s <strong>${action.name}</strong>${t?` against <strong style="color:var(--red2)">${t.name}</strong>`:''}<br><br><span style="font-size:12px;color:var(--text2);">${bc} can block this.</span>`;
  P.blockCb=onAllow;
  openM('block-modal');
}

function resolveBlock(dec){
  closeM('block-modal');
  if(dec==='allow'){if(P.blockCb)P.blockCb();}
  else{load(ME.room).then(room=>{const me=room.players.find(p=>p.id===ME.id);addLog(room,`üõ° ${me.name}'s action was blocked!`);room.version++;save(ME.room,room).then(()=>endTurn(room));});}
}

async function executeAction(action,targetIdx,room){
  const me=room.players.find(p=>p.id===ME.id);
  const t=targetIdx!==null?room.players[targetIdx]:null;
  switch(action.key){
    case 'income':me.coins+=1;addLog(room,`üí∞ ${me.name} took Income (+1 coin) ‚Üí ${me.coins}`);room.version++;await save(ME.room,room);endTurn(room);break;
    case 'foreign_aid':me.coins+=2;addLog(room,`üè¶ ${me.name} took Foreign Aid (+2 coins) ‚Üí ${me.coins}`);room.version++;await save(ME.room,room);endTurn(room);break;
    case 'tax':me.coins+=3;addLog(room,`üëë ${me.name} collected Tax (+3 coins) ‚Üí ${me.coins}`);room.version++;await save(ME.room,room);endTurn(room);break;
    case 'coup':me.coins-=7;addLog(room,`üí• ${me.name} launched a Coup against ${t.name}!`);room.version++;await save(ME.room,room);doLoseCard(room,room.players.indexOf(t),async()=>{const r2=await load(ME.room);if(elim(r2.players.find(x=>x.id===t.id))){addLog(r2,`üíÄ ${t.name} has been eliminated!`);r2.version++;await save(ME.room,r2);}checkWin(r2)||endTurn(r2);});break;
    case 'assassinate':me.coins-=3;addLog(room,`üó° ${me.name} assassinated ${t.name}!`);room.version++;await save(ME.room,room);doLoseCard(room,room.players.indexOf(t),async()=>{const r2=await load(ME.room);if(elim(r2.players.find(x=>x.id===t.id))){addLog(r2,`üíÄ ${t.name} has been eliminated!`);r2.version++;await save(ME.room,r2);}checkWin(r2)||endTurn(r2);});break;
    case 'steal':const s=Math.min(2,t.coins);t.coins-=s;me.coins+=s;addLog(room,`‚öì ${me.name} stole ${s} coin(s) from ${t.name}`);room.version++;await save(ME.room,room);endTurn(room);break;
    case 'exchange':await doExchange(room,me);break;
  }
}

function doLoseCard(room,pi,cb){
  const p=room.players[pi];
  if(p.cards.length===0){if(cb)cb();return;}
  if(p.cards.length===1){const l=p.cards.pop();p.deadCards.push(l);addLog(room,`üíÄ ${p.name} lost ${CARDS[l].emoji} ${CARDS[l].name}`);room.version++;save(ME.room,room).then(()=>{if(cb)cb();});return;}
  document.getElementById('lmb').textContent=`${p.name} ‚Äî choose a card to lose`;
  const list=document.getElementById('lcl');list.innerHTML='';
  p.cards.forEach((c,i)=>{
    const btn=document.createElement('button');btn.className='cpick';btn.style.borderColor=CARDS[c].border;btn.style.background=CARDS[c].bg;
    btn.innerHTML=`<div class="cpe">${CARDS[c].emoji}</div><div class="cpn">${CARDS[c].name}</div>`;
    btn.onclick=async()=>{const l=p.cards.splice(i,1)[0];p.deadCards.push(l);addLog(room,`üíÄ ${p.name} lost ${CARDS[l].emoji} ${CARDS[l].name}`);room.version++;closeM('lose-modal');await save(ME.room,room);if(cb)cb();};
    list.appendChild(btn);
  });
  openM('lose-modal');
}

async function doExchange(room,me){
  const drawn=[];
  if(room.deck.length>0)drawn.push(room.deck.pop());
  if(room.deck.length>0)drawn.push(room.deck.pop());
  const avail=[...me.cards,...drawn];
  P.excAvail=avail;P.excSel=[];P.excKeep=me.cards.length;P.excRoom=room;P.excMe=me;
  const list=document.getElementById('ecl');list.innerHTML='';
  avail.forEach((c,i)=>{
    const btn=document.createElement('button');btn.className='cpick';btn.style.borderColor=CARDS[c].border;btn.dataset.idx=i;
    btn.innerHTML=`<div class="cpe">${CARDS[c].emoji}</div><div class="cpn">${CARDS[c].name}</div>`;
    btn.onclick=()=>toggleExc(btn,i,c);
    list.appendChild(btn);
  });
  updateExcUI();
  openM('exchange-modal');
}

function toggleExc(btn,idx,card){
  const sel=P.excSel;const pos=sel.findIndex(s=>s.idx===idx);
  if(pos>-1){sel.splice(pos,1);btn.classList.remove('sel');}
  else{if(sel.length>=P.excKeep){const old=sel.shift();const ob=document.querySelector(`#ecl [data-idx="${old.idx}"]`);if(ob)ob.classList.remove('sel');}sel.push({idx,card});btn.classList.add('sel');}
  updateExcUI();
}

function updateExcUI(){
  const sel=P.excSel,need=P.excKeep;
  document.getElementById('econf').disabled=sel.length!==need;
  document.getElementById('ehint').textContent=sel.length>0?'Keeping: '+sel.map(s=>CARDS[s.card].emoji+' '+CARDS[s.card].name).join(', '):`Select ${need} card${need>1?'s':''} to keep`;
}

async function confirmExchange(){
  const sel=P.excSel,avail=P.excAvail,room=P.excRoom,me=P.excMe;
  const ret=avail.filter((_,i)=>!sel.find(s=>s.idx===i));
  ret.forEach(c=>room.deck.unshift(c));shuffle(room.deck);
  me.cards=sel.map(s=>s.card);
  addLog(room,`ü§ù ${me.name} exchanged cards with the Court deck`);
  room.version++;closeM('exchange-modal');
  await save(ME.room,room);endTurn(room);
}

function endTurn(room){
  let n=(room.currentIdx+1)%room.players.length,t=0;
  while(elim(room.players[n])&&t<room.players.length){n=(n+1)%room.players.length;t++;}
  room.currentIdx=n;room.version++;save(ME.room,room);
}

function checkWin(room){
  const alive=room.players.filter(p=>!elim(p));
  if(alive.length<=1){room.status='finished';room.version++;save(ME.room,room);return true;}
  return false;
}

function copyCode(){const c=document.getElementById('rcd').textContent;navigator.clipboard.writeText(c).then(()=>toast('Code copied: '+c)).catch(()=>toast('Code: '+c));}
function goLobby(){clearInterval(syncInt);showS('lobby');}

// Build ref
(function(){
  const g=document.getElementById('rgrid');
  Object.values(CARDS).forEach(ct=>{
    const d=document.createElement('div');d.className='ri';d.style.background=ct.bg;d.style.borderColor=ct.border;
    d.innerHTML=`<div class="rit" style="color:${ct.border}">${ct.emoji} ${ct.name}</div><div class="ril">‚ö° ${ct.action}</div><div class="ril">üõ° ${ct.blocks}</div>`;
    g.appendChild(d);
  });
})();

document.querySelectorAll('.overlay').forEach(o=>{
  o.addEventListener('click',e=>{if(e.target===o&&o.id!=='lose-modal'&&o.id!=='exchange-modal')o.classList.remove('open');});
});
</script>
</body>
</html>
